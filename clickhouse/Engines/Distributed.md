# Distributed

**Distributed 引擎本身不存储数据** 但允许在多个服务器上进行分布式查询处理。读取将自动并行化。

在读取期间，将使用远程服务器上的表索引(如果有)。

分布式引擎接受参数:服务器配置文件中的群集名称、远程数据库的名称、远程表的名称和分片键(可选)。

范例:
```
Distributed(logs, default, hits[, sharding_key])
```

数据将从`logs`群集中的所有服务器上的每个服务器中的`default.hits`表中读取。
不仅读取数据，而且在远程服务器上处理数据(尽可能)。
例如，对于GROUP BY查询，将在远程服务器上聚合数据，并将聚合函数的中间状态发送到请求服务器。然后数据将被进一步聚合。

您可以使用传回字串的表达式，而不是string名称。例如，current database ()。

logs — 服务器配置文件中的群集名称。
```
<remote_servers>
    <logs>
        <shard>
            <!-- Optional. Shard weight when writing data. By default, 1. -->
            <weight>1</weight>
            <!-- Optional. Whether to write data to just one of the replicas. By default, false - write data to all of the replicas. -->
            <internal_replication>false</internal_replication>
            <replica>
                <host>example01-01-1</host>
                <port>9000</port>
            </replica>
            <replica>
                <host>example01-01-2</host>
                <port>9000</port>
            </replica>
        </shard>
        <shard>
            <weight>2</weight>
            <internal_replication>false</internal_replication>
            <replica>
                <host>example01-02-1</host>
                <port>9000</port>
            </replica>
            <replica>
                <host>example01-02-2</host>
                <port>9000</port>
            </replica>
        </shard>
    </logs>
</remote_servers>
```

此处定义了一个名为`logs`群集，该群集由两个分片(Shards)组成，每个分片包含两个副本(Replicas)。
分片是指包含不同数据部分的服务器(要读取所有数据，必须访问所有分片)。
副本指有同样数据的服务器(为了读取所有数据，您可以访问任意一个副本上的数据)。

对于每台服务器，都有几个参数:必填项:“host”，“port”，可选项:“user”，“password”。
* host：远程服务器的地址。可以指定为域名或IPv4或IPv6地址。如果指定域，服务器将在启动时执行DNS查找，结果将缓存到服务器关闭。
如果DNS请求失败，服务器将无法启动。如果要更改DNS记录，请重新启动服务器以使新记录生效。
* port： TCP -用于服务器间通信的端口(配置文件中的tcp_port ，通常为9000)。不要与http _port混淆。
* user：要连接到远程服务器的用户名。默认情况下，用户为“default”。此用户必须具有访问权限才能连接到远程服务器。访问权限在users.xml配置文件中进行管理。有关其他信息，请参阅“访问权限”部分。
* password：以明文形式登录到远程服务器的密码。默认值为空字符串。

指定复制副本时，读取时将为每个分片选择一个可用的副本。您可以配置负载平衡算法(要访问哪个复制副本的首选项) -请参阅“load _balancing”设置。
如果未建立与服务器的连接，将尝试使用短超时进行连接。如果连接失败，则将为所有复制副本选择下一个复制副本，依此类推。
如果所有复制副本的连接尝试失败，则尝试将以相同的方式重复几次。
这有利于恢复能力，但不能提供完整的容错能力:远程服务器可能接受连接，但可能无法工作，或者工作不佳。

您可以只指定其中一个分片(在本例中，查询处理应该称为远程分片，而不是分布式分片)，或者最多指定任意数量的分片。
在每个分片中，可以指定从一个到任意数量的副本。您可以为每个碎片指定不同数量的副本。

您可以在配置中指定任意数量的群集。

要查看群集，请使用“system.clusters”表。

Distributed 引擎允许使用群集(如本地服务器)。但是，群集是不可扩展的:必须将其配置写入服务器配置文件(更好的是，对于所有群集的服务器)。

不支持叠加在其他分布式表的分布式表(除非分布式表只有一个分片)。或者，让分布式表像一个“final”表。

Distributed 引擎需要将群集写入配置文件。config中的群集是动态更新的，不需要重新启动服务器。
如果每次都需要向不确定的碎片和副本集发送查询，则不需要创建分布式表，而是使用“remote”表函数。请参阅“Table function”一节。

将数据写入群集有两种方法:
* 首先，您可以定义要向哪些服务器写入哪些数据，并直接对每个分片执行写入。换句话说，直接向分布式表背后的表中执行INSERT。
这是最灵活的解决方案。因为某些原因，您可以使用任何分片方案，这可能是非常重要的。这也几乎是最佳的解决方案，因为数据可以完全独立地写入不同的碎片。
* 其次，可以对分布式表执行插入。在这种情况下，表将跨服务器本身分发插入的数据。要写入分布式表，必须设置分片键(最后一个参数)。
此外，如果只有一个分片，则写入操作在不指定分片键的情况下工作，因为在这种情况下它没有任何意义。


每个分片可以在配置文件中定义一个权重。默认情况下，权重等于1。数据以与分片权重成比例的量分布在分片之间。
例如，如果有两个分片，第一个碎片的权重为9，而第二个碎片的权重为10，则第一个分片将发送行的9 / 19部分，第二个分片将发送行的10 /19部分。

每个分片都可以在配置文件中定义“internal_replication”参数。
如果此参数设置为“true”，则写入操作将选择第一个运行状况良好的副本并将数据写入其中。如果分布式表基于有副本的表，请使用此替代方法。
换句话说，如果要写入数据的表本身要复制它们。

如果将其设置为“false”(默认值)，则将数据写入所有副本。本质上，这意味着分布式表本身复制数据。
这比使用自己本身有副本的表更差，因为复制副本的一致性不会被检查，而且随着时间的推移，它们将包含稍微不同的数据。


要选择一行数据发送到的分片，将分析分片表达式，并从将其除以分片的总权重中提取剩余部分。
该行被发送到分片，该分片对应于从“prev_weight”到“prev_weights + weight”的剩余碎片的半间隔，其中“prev_weight”是具有最小数目的碎片的总重量，“weight”是该碎片的重量。
例如，如果有两个分片，第一个分片的权重为9，而第二个分片的权重为10，则对于范围[ 0，9 )中的余数，行将被发送到第一个分片，对于范围[ 10，19)中的余数，行将被发送到第二个分片。


分片表达式可以是来自返回整数的常量和表列的任何表达式。例如，您可以使用表达式“rand()”来随机分发数据，或者使用“UserID”来分发用户ID除以用户ID的余数(然后，单个用户的数据将驻留在单个分片上，这简化了用户在其中运行和连接)。
如果其中一列分布不均匀，则可以将其包装为hash函数: intHash64(UserID)

除法的简单余数是用于分片的有限解决方案，并不总是合适的。它适用于大中型数据量(数十台服务器)，但不适用于超大数据量(数百台或更多服务器)。
在后一种情况下，使用目的相关的分片方案，而不是使用分布式表中的条目。

使用复制(Replicated)表时，可以重新设置数据-请参阅“Resharding”部分。但在许多情况下，最好不要这样做。
SELECT查询被发送到所有分片，并且不管数据如何分布在分片上(它们可以完全随机分布)。
添加新分片时，不必向其传输旧数据。您可以使用较重的权重写入新数据-数据的分布将稍微不均匀，但查询将正确高效地工作。

在以下情况下，您应该关注分片方案: 
* 使用需要通过特定键连接数据((IN or JOIN))的查询。如果数据是由该键分割的，则可以使用local IN或JOIN，而不是GLOBAL IN或GLOBALJOIN，这样效率要高得多。
* 大量服务器(数百个或更多)用于大量小查询(对单个客户的查询-网站、广告商或合作伙伴)。为了使小查询不影响整个集群，在单个分片上定位单个客户端的数据是有意义的。
或者，正如我们在Yandex.Metrica所做的那样。您可以设置两级分片:将整个集群划分为“layers(层)”，其中一个层可以由多个分片组成。单个客户端的数据位于单个层上，但可以根据需要将碎片添加到层中，并且数据在其中随机分布。
为每个层创建分布式表，并为全局查询创建单个共享分布式表。

数据是异步写入的。对于对分布式表的插入，数据块仅写入本地文件系统。数据将尽快发送到后台的远程服务器。您应该通过检查表目录: `/var/lib/clickhouse/data/database/table/`

如果服务器在插入分布式表后宕机在或被粗暴的重启(例如，在设备故障后)，则插入的数据可能会丢失。如果在表目录中检测到损坏的数据部分，则将其传输到“broken”子目录，并且不再使用。




